
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>The Finite Difference Method: 1D steady state heat transfer &#8212; AEROSP 523 Computational Fluid Dynamics: Code Examples</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'Examples/Week3/FiniteDifferenceScheme_bis';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Week 4" href="../Week4/Week4.html" />
    <link rel="prev" title="Week 3" href="Week3.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/scramjet.png" class="logo__image only-light" alt="AEROSP 523 Computational Fluid Dynamics: Code Examples - Home"/>
    <script>document.write(`<img src="../../_static/scramjet.png" class="logo__image only-dark" alt="AEROSP 523 Computational Fluid Dynamics: Code Examples - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../intro.html">
                    AEROSP 523 Computational Fluid Dynamics: Code Examples
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../Content/PythonSetup.html">Getting Started with Python</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Week1/Week1.html">Week 1</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../Week1/intro_jax.html">Introduction to JAX</a></li>

<li class="toctree-l2"><a class="reference internal" href="../Week1/RootFinding.html">Root finding methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Week1/homework_1_0.html">Homework 1 - Solution</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Week2/Week2.html">Week 2</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../Week2/FiniteDifferences.html">Finite Difference Approximations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Week2/homework_2_0.html">Homework 2 code solution</a></li>
</ul>
</details></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="Week3.html">Week 3</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2 current active"><a class="current reference internal" href="#">The Finite Difference Method: 1D steady state heat transfer</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Week4/Week4.html">Week 4</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../Week4/IterativeSolvers.html">Iterative linear solvers</a></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/mariejvaucher/aero523-fall24/main?urlpath=lab/tree/Examples/Week3/FiniteDifferenceScheme_bis.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Binder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Binder logo" src="../../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/mariejvaucher/aero523-fall24" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/mariejvaucher/aero523-fall24/issues/new?title=Issue%20on%20page%20%2FExamples/Week3/FiniteDifferenceScheme_bis.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/Examples/Week3/FiniteDifferenceScheme_bis.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>The Finite Difference Method: 1D steady state heat transfer</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#convergence-study">Convergence study</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-thermal-conductivity-from-measurement-data">Learning thermal conductivity from measurement data</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="the-finite-difference-method-1d-steady-state-heat-transfer">
<h1>The Finite Difference Method: 1D steady state heat transfer<a class="headerlink" href="#the-finite-difference-method-1d-steady-state-heat-transfer" title="Link to this heading">#</a></h1>
<p>These examples are based on code originally written by Krzysztof Fidkowski and adapted by Venkat Viswanathan.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">jax</span>
<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
<span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">grad</span><span class="p">,</span> <span class="n">jit</span>

<span class="kn">from</span> <span class="nn">jax.scipy.linalg</span> <span class="kn">import</span> <span class="n">solve</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span>

<span class="n">jax</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s2">&quot;jax_enable_x64&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>  <span class="c1"># Enable 64-bit precision for better numerical stability</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">niceplots</span>

<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="n">niceplots</span><span class="o">.</span><span class="n">get_style</span><span class="p">())</span>

<span class="c1"># Force the jupyter notebook to use vector graphics</span>
<span class="kn">import</span> <span class="nn">matplotlib_inline</span>

<span class="n">matplotlib_inline</span><span class="o">.</span><span class="n">backend_inline</span><span class="o">.</span><span class="n">set_matplotlib_formats</span><span class="p">(</span><span class="s2">&quot;pdf&quot;</span><span class="p">,</span> <span class="s2">&quot;svg&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>This code implements the example case from section 3.1.1 of the course notes.</p>
<p>We will solve the steady state heat transfer equation in 1D:</p>
<div class="math notranslate nohighlight">
\[ -\kappa\frac{d^2T}{dx^2} = q(x) \]</div>
<p>where <span class="math notranslate nohighlight">\(\kappa\)</span> is the thermal conductivity, <span class="math notranslate nohighlight">\(T\)</span> is the temperature, <span class="math notranslate nohighlight">\(x\)</span> is the position, and <span class="math notranslate nohighlight">\(q(x)\)</span> is a heat source term, which in this case is <span class="math notranslate nohighlight">\(\sin\left(\pi x /L\right)\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define the symbolic function q(x)</span>
<span class="k">def</span> <span class="nf">q</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">L</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">x</span> <span class="o">/</span> <span class="n">L</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The 1D domain spans <span class="math notranslate nohighlight">\(0 \le x \le L\)</span> and is split into <span class="math notranslate nohighlight">\(N\)</span> intervals of length <span class="math notranslate nohighlight">\(\Delta x = L/N\)</span>, this gives <span class="math notranslate nohighlight">\(N+1\)</span> nodes in the grid. The temperatures at the nodes are <span class="math notranslate nohighlight">\(T_0, T_1, \ldots, T_N\)</span>. Dirichlet boundary conditions are applied at <span class="math notranslate nohighlight">\(x=0\)</span> and <span class="math notranslate nohighlight">\(x=L\)</span>, such that <span class="math notranslate nohighlight">\(T_0 = 1\)</span> and <span class="math notranslate nohighlight">\(T_N=4\)</span>.</p>
<p><img alt="The finite-difference grid" src="../../_images/FDDomain.svg" /></p>
<p>Using the central difference approximation for the second derivative, we can write the equation at each node as:</p>
<div class="math notranslate nohighlight">
\[ -\kappa\frac{T_{i-1} - 2T_i + T_{i+1}}{\Delta x^2} = q(x_i) \Rightarrow -T_{i-1} + 2T_i - T_{i+1} = \frac{1}{\kappa} \Delta x^2 q(x_i)\]</div>
<p>We will enforce this equation at all nodes except the boundary nodes, which have known temperatures. This gives <span class="math notranslate nohighlight">\(N-1\)</span> equations for the <span class="math notranslate nohighlight">\(N+1\)</span> unknown temperatures. At nodes <span class="math notranslate nohighlight">\(i=1\)</span> and <span class="math notranslate nohighlight">\(i=N-1\)</span>, we have to rearrange the equation to account for the known temperature values that appear in the finite difference stencil:</p>
<div class="math notranslate nohighlight">
\[\text{at } i=1, \quad 2T_1 - T_2 = \frac{1}{\kappa} \Delta x^2 q(x_i) + T_0\]</div>
<div class="math notranslate nohighlight">
\[\text{at } i=N-1, \quad -T_{N-2} + 2T_{N-1} = \frac{1}{\kappa} \Delta x^2 q(x_i) + T_N\]</div>
<p>Writing this all up in matrix-form we get:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{bmatrix}
2 &amp; -1 &amp; 0 &amp; 0 &amp; \cdots &amp; 0 \\
-1 &amp; 2 &amp; -1 &amp; 0 &amp; \cdots &amp; 0 \\
0 &amp; -1 &amp; 2 &amp; -1 &amp; \cdots &amp; 0 \\
\vdots &amp; \vdots &amp; \vdots &amp; \ddots &amp; \vdots &amp; \vdots \\
0 &amp; \cdots &amp; 0 &amp; -1 &amp; 2 &amp; -1 \\
0 &amp; \cdots &amp; 0 &amp; 0 &amp; -1 &amp; 2
\end{bmatrix}
\begin{bmatrix}
T_1 \\ T_2 \\ T_3 \\ \vdots \\ T_{N-1}
\end{bmatrix}
=
\begin{bmatrix}
q(x_1) \Delta x^2 / \kappa + T_0 \\ q(x_2) \Delta x^2 / \kappa \\ q(x_3) \Delta x^2 / \kappa \\ \vdots \\ q(x_{N-1}) \Delta x^2 / \kappa + T_N
\end{bmatrix}
\end{split}\]</div>
<p>Alternatively, we can keep the boundary nodes in the matrix equation, and enforce the boundary conditions using the first and last rows of the matrix:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{bmatrix}
1 &amp; 0 &amp; 0 &amp; 0 &amp; \cdots &amp; 0 \\
-1 &amp; 2 &amp; -1 &amp; 0 &amp; \cdots &amp; 0 \\
0 &amp; -1 &amp; 2 &amp; -1 &amp; \cdots &amp; 0 \\
\vdots &amp; \vdots &amp; \vdots &amp; \ddots &amp; \vdots &amp; \vdots \\
0 &amp; \cdots &amp; 0 &amp; -1 &amp; 2 &amp; -1 \\
0 &amp; \cdots &amp; 0 &amp; 0 &amp; 0 &amp; 1
\end{bmatrix}
\begin{bmatrix}
T_0 \\ T_1 \\ T_2 \\ \vdots \\ T_{N-1} \\ T_{N}
\end{bmatrix}
=
\begin{bmatrix}
T_0 \\ q(x_1)\Delta x^2 / \kappa \\ q(x_2)\Delta x^2 / \kappa \\ \vdots \\ q(x_{N-1})\Delta x^2 / \kappa \\ T_N)
\end{bmatrix}
\end{split}\]</div>
<p>The code below implements the second approach, and solves the matrix equation using a direct sparse linear solver.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">heat_conduction</span><span class="p">(</span><span class="n">T_left</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">T_right</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">kappa</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">Nx</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Setup and solve the heat conduction problem using the finite difference method</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    T_left : float, optional</span>
<span class="sd">        Left boundary temperature, by default 1.0</span>
<span class="sd">    T_right : float, optional</span>
<span class="sd">        Right boundary temperature, by default 4.0</span>
<span class="sd">    L : float, optional</span>
<span class="sd">        Length of domain, by default 2.0</span>
<span class="sd">    kappa : float, optional</span>
<span class="sd">        Thermal conductivity, by default 0.5</span>
<span class="sd">    Nx : int, optional</span>
<span class="sd">        Number of intervals, by default 10</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    array</span>
<span class="sd">        Nodal temperature values</span>
<span class="sd">    array</span>
<span class="sd">        Nodal x coordinates</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Define the parameters</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">L</span> <span class="o">/</span> <span class="n">Nx</span>  <span class="c1"># Grid spacing</span>

    <span class="c1"># Create the matrix A (tridiagonal with 2 on the diagonal and -1 on the off-diagonals)</span>
    <span class="n">diagonal</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">Nx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">off_diagonal</span> <span class="o">=</span> <span class="o">-</span><span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">Nx</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">diagonal</span><span class="p">)</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">off_diagonal</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">off_diagonal</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Add the Boundary conditions</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">A</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">A</span><span class="p">))</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">A</span><span class="p">])</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">A</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">at</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">at</span><span class="p">[(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>  <span class="c1"># Set the bottom-right diagonal element to 1</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">at</span><span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">at</span><span class="p">[(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>  <span class="c1"># Set the bottom-right diagonal element to 1</span>

    <span class="c1"># Create the vector representing the heat source (modify q(x) as needed)</span>
    <span class="n">x_values</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">Nx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">Nx</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="n">x_values</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">Nx</span><span class="p">],</span> <span class="n">L</span><span class="p">)</span> <span class="o">/</span> <span class="n">kappa</span> <span class="o">*</span> <span class="n">dx</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Define boundary conditions (e.g., fixed temperature at both ends)</span>
    <span class="n">T_left</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">T_right</span> <span class="o">=</span> <span class="mf">4.0</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">T_left</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">T_right</span><span class="p">)</span>

    <span class="n">T</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">T</span><span class="p">,</span> <span class="n">x_values</span>
</pre></div>
</div>
</div>
</div>
<p>Now let’s solve the system for <span class="math notranslate nohighlight">\(N=3\)</span> and plot the results compared to the analytical solution:</p>
<div class="math notranslate nohighlight">
\[T_\text{exact} (x) = \frac{L^2}{\kappa \pi^2}\sin\left(\frac{\pi x}{L}\right) + T_0 + \frac{x}{L}\left(T_N - T_0\right)\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define the true solution</span>
<span class="k">def</span> <span class="nf">true_solution</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">T_left</span><span class="p">,</span> <span class="n">T_right</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">L</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">kappa</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">x</span> <span class="o">/</span> <span class="n">L</span><span class="p">)</span> <span class="o">+</span> <span class="n">T_left</span> <span class="o">+</span> <span class="p">(</span><span class="n">T_right</span> <span class="o">-</span> <span class="n">T_left</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span> <span class="o">/</span> <span class="n">L</span>


<span class="c1"># Define the parameters</span>
<span class="n">L</span> <span class="o">=</span> <span class="mf">2.0</span>  <span class="c1"># Length of domain</span>
<span class="n">kappa</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># Thermal conductivity</span>
<span class="n">Nx</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># Number of intervals</span>
<span class="n">T0</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># Left boundary condition</span>
<span class="n">TN</span> <span class="o">=</span> <span class="mf">4.0</span>  <span class="c1"># Right boundary condition</span>

<span class="c1"># Solve the finite difference problem</span>
<span class="n">T_soln</span><span class="p">,</span> <span class="n">x_vals</span> <span class="o">=</span> <span class="n">heat_conduction</span><span class="p">(</span><span class="n">T0</span><span class="p">,</span> <span class="n">TN</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">Nx</span><span class="p">)</span>

<span class="c1"># Plot the results against the true solution</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">xTrue</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xTrue</span><span class="p">,</span> <span class="n">true_solution</span><span class="p">(</span><span class="n">xTrue</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">T0</span><span class="p">,</span> <span class="n">TN</span><span class="p">),</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">clip_on</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;True solution&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">T_soln</span><span class="p">,</span> <span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="n">clip_on</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;FD solution&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;$x$&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$T$&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="n">T0</span><span class="p">,</span> <span class="n">TN</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">labelcolor</span><span class="o">=</span><span class="s2">&quot;linecolor&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower right&quot;</span><span class="p">)</span>
<span class="n">niceplots</span><span class="o">.</span><span class="n">adjust_spines</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/b9cfa4369c574b7f931bf8fd413c34f05c0209908ee02c22a0c428a955f4e791.svg" src="../../_images/b9cfa4369c574b7f931bf8fd413c34f05c0209908ee02c22a0c428a955f4e791.svg" />
</div>
</div>
<p>Even with only 3 intervals, the solution is already quite close to the exact solution.</p>
<section id="convergence-study">
<h2>Convergence study<a class="headerlink" href="#convergence-study" title="Link to this heading">#</a></h2>
<p>Since we are using a second-order accurate approximation of <span class="math notranslate nohighlight">\(\frac{d^2T}{dx^2}\)</span>, we expect the error to be proportional to <span class="math notranslate nohighlight">\(\Delta x^2\)</span>. Let’s verify this by solving the system for a range of values of <span class="math notranslate nohighlight">\(N\)</span> and plotting the error as a function of <span class="math notranslate nohighlight">\(\Delta x\)</span>.</p>
<p>The error is computed using the <span class="math notranslate nohighlight">\(L_2\)</span> norm as given in chapter 1 of the course notes:</p>
<div class="math notranslate nohighlight">
\[\text{Error} = \sqrt{\frac{1}{N+1}\sum_0^{N}\left(T_i - T_\text{exact}(x_i)\right)^2}\]</div>
<p>This is not equivalent to the typical <span class="math notranslate nohighlight">\(L_2\)</span> computed by numpy/JAX, which do not normalize by the number of elements, and would therefore give the wrong order of convergence.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Nsweep</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>
<span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">Nx</span> <span class="ow">in</span> <span class="n">Nsweep</span><span class="p">:</span>
    <span class="n">T_soln</span><span class="p">,</span> <span class="n">x_vals</span> <span class="o">=</span> <span class="n">heat_conduction</span><span class="p">(</span><span class="n">T0</span><span class="p">,</span> <span class="n">TN</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">Nx</span><span class="p">)</span>
    <span class="n">error</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">Nx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">T_soln</span> <span class="o">-</span> <span class="n">true_solution</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">T0</span><span class="p">,</span> <span class="n">TN</span><span class="p">))))</span>
    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;$\Delta x$&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$||T_</span><span class="si">{FD}</span><span class="s2"> - T_</span><span class="si">{true}</span><span class="s2">||_2$&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">L</span> <span class="o">/</span> <span class="n">Nsweep</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="n">clip_on</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Compute the convergence rate by fitting a line to the log-log plot</span>
<span class="n">rate</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">L</span> <span class="o">/</span> <span class="n">Nsweep</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">errors</span><span class="p">)),</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Convergence rate: </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">rate</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">L</span> <span class="o">/</span> <span class="n">Nsweep</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">errors</span><span class="p">[</span><span class="mi">5</span><span class="p">]),</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;top&quot;</span><span class="p">)</span>

<span class="n">niceplots</span><span class="o">.</span><span class="n">adjust_spines</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;&gt;:10: SyntaxWarning: invalid escape sequence &#39;\D&#39;
&lt;&gt;:10: SyntaxWarning: invalid escape sequence &#39;\D&#39;
/tmp/ipykernel_2368/2426008397.py:10: SyntaxWarning: invalid escape sequence &#39;\D&#39;
  ax.set_xlabel(&quot;$\Delta x$&quot;)
</pre></div>
</div>
<img alt="../../_images/5ba31aa9c9ddd1b5fb60d785ceb59f975e0b6de0c5221d175eb066cdbe20475b.svg" src="../../_images/5ba31aa9c9ddd1b5fb60d785ceb59f975e0b6de0c5221d175eb066cdbe20475b.svg" />
</div>
</div>
</section>
<section id="learning-thermal-conductivity-from-measurement-data">
<h2>Learning thermal conductivity from measurement data<a class="headerlink" href="#learning-thermal-conductivity-from-measurement-data" title="Link to this heading">#</a></h2>
<p>Now we will leverage the power of JAX to solve an inverse problem: given some measured temperatures, we will try to find the value of the thermal conductivity that best matches the data.</p>
<p>In this case, we will generate our “experimental data” by running the FD code with a given value of <span class="math notranslate nohighlight">\(\kappa\)</span>, this way we can tell if our learning process has been successful.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Nx</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">measured_temps</span><span class="p">,</span> <span class="n">measurement_locations</span> <span class="o">=</span> <span class="n">heat_conduction</span><span class="p">(</span><span class="n">T0</span><span class="p">,</span> <span class="n">TN</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">Nx</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Next we define our “loss” or “objective” function, this is the function that we will try to minimize. In this case, we will use the <span class="math notranslate nohighlight">\(L_2\)</span> norm of the difference between the measured temperatures and the temperatures computed by the FD code. We will also use JAX to create a function that computes <span class="math notranslate nohighlight">\(\frac{df}{d\kappa}\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">obj_function</span><span class="p">(</span><span class="n">kappa</span><span class="p">):</span>
    <span class="n">predicted_temps</span> <span class="o">=</span> <span class="n">heat_conduction</span><span class="p">(</span><span class="n">T0</span><span class="p">,</span> <span class="n">TN</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">Nx</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">error</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">predicted_temps</span> <span class="o">-</span> <span class="n">measured_temps</span><span class="p">))</span>
    <span class="c1"># Print the current kappa and error, the try/except block is so that the printing is skipped when JAX AD&#39;s this function</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;kappa = </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">kappa</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">:</span><span class="s2"> .7e</span><span class="si">}</span><span class="s2">, error = </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="si">:</span><span class="s2"> .7e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">error</span>

<span class="n">obj_grad</span> <span class="o">=</span> <span class="n">grad</span><span class="p">(</span><span class="n">obj_function</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now we will use an algorithm called an optimizer to find the value of <span class="math notranslate nohighlight">\(\kappa\)</span> that minimizes the objective function. For problems where we expect the objective function to be smooth, gradient-based optimizers are the most efficient methods. Here we use an optimizer provided by JAX which will use the gradient information computed by JAX’s AD to find the minimum.</p>
<p>A popular optimization algorithm used is gradient-descent. There are a few different versions of gradient descent, adam being one of the most popular in machine learning, but here we will use the simplest one. At each iteration we compute the gradient of the objective function and then simply take a step in the downhill direction, scaled by a value <span class="math notranslate nohighlight">\(\lambda\)</span> which people in the machine learning community like to call the “learning rate”:</p>
<div class="math notranslate nohighlight">
\[x_{i+1} = x_i - \lambda \frac{df}{dx}\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">gradient_descent</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">grad_f</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">step_size</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x0</span>
    <span class="n">converged</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">dfdx</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">x_hist</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iter</span><span class="p">):</span>
        <span class="n">func_val</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">dfdx</span> <span class="o">=</span> <span class="n">grad_f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">jnp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">func_val</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
            <span class="n">converged</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">break</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">step_size</span> <span class="o">*</span> <span class="n">dfdx</span>
        <span class="n">x_hist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">converged</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converged after </span><span class="si">{</span><span class="n">ii</span><span class="si">}</span><span class="s2"> iterations&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Did not converge after </span><span class="si">{</span><span class="n">max_iter</span><span class="si">}</span><span class="s2"> iterations&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">func_val</span><span class="p">,</span> <span class="n">x_hist</span>


<span class="n">kappa_grad_descent</span><span class="p">,</span> <span class="n">error_grad_descent</span><span class="p">,</span> <span class="n">kappa_hist</span> <span class="o">=</span> <span class="n">gradient_descent</span><span class="p">(</span><span class="n">obj_function</span><span class="p">,</span> <span class="n">obj_grad</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.34</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>kappa =  2.3400000e+00, error =  4.0791601e+00
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>kappa =  2.3305259e+00, error =  4.0701527e+00
kappa =  2.3209852e+00, error =  4.0610179e+00
kappa =  2.3113767e+00, error =  4.0517525e+00
kappa =  2.3016992e+00, error =  4.0423531e+00
kappa =  2.2919515e+00, error =  4.0328165e+00
kappa =  2.2821322e+00, error =  4.0231392e+00
kappa =  2.2722402e+00, error =  4.0133174e+00
kappa =  2.2622741e+00, error =  4.0033475e+00
kappa =  2.2522325e+00, error =  3.9932255e+00
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>kappa =  2.2421139e+00, error =  3.9829473e+00
kappa =  2.2319170e+00, error =  3.9725089e+00
kappa =  2.2216401e+00, error =  3.9619058e+00
kappa =  2.2112818e+00, error =  3.9511334e+00
kappa =  2.2008405e+00, error =  3.9401872e+00
kappa =  2.1903145e+00, error =  3.9290620e+00
kappa =  2.1797020e+00, error =  3.9177530e+00
kappa =  2.1690014e+00, error =  3.9062547e+00
kappa =  2.1582109e+00, error =  3.8945616e+00
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>kappa =  2.1473285e+00, error =  3.8826680e+00
kappa =  2.1363523e+00, error =  3.8705679e+00
kappa =  2.1252803e+00, error =  3.8582550e+00
kappa =  2.1141105e+00, error =  3.8457227e+00
kappa =  2.1028407e+00, error =  3.8329644e+00
kappa =  2.0914686e+00, error =  3.8199728e+00
kappa =  2.0799921e+00, error =  3.8067405e+00
kappa =  2.0684087e+00, error =  3.7932598e+00
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>kappa =  2.0567159e+00, error =  3.7795224e+00
kappa =  2.0449113e+00, error =  3.7655200e+00
kappa =  2.0329921e+00, error =  3.7512435e+00
kappa =  2.0209556e+00, error =  3.7366837e+00
kappa =  2.0087989e+00, error =  3.7218307e+00
kappa =  1.9965192e+00, error =  3.7066743e+00
kappa =  1.9841133e+00, error =  3.6912035e+00
kappa =  1.9715780e+00, error =  3.6754072e+00
kappa =  1.9589100e+00, error =  3.6592733e+00
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>kappa =  1.9461058e+00, error =  3.6427894e+00
kappa =  1.9331619e+00, error =  3.6259421e+00
kappa =  1.9200743e+00, error =  3.6087175e+00
kappa =  1.9068393e+00, error =  3.5911010e+00
kappa =  1.8934528e+00, error =  3.5730770e+00
kappa =  1.8799104e+00, error =  3.5546291e+00
kappa =  1.8662077e+00, error =  3.5357399e+00
kappa =  1.8523400e+00, error =  3.5163913e+00
kappa =  1.8383025e+00, error =  3.4965636e+00
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>kappa =  1.8240900e+00, error =  3.4762364e+00
kappa =  1.8096972e+00, error =  3.4553877e+00
kappa =  1.7951184e+00, error =  3.4339943e+00
kappa =  1.7803479e+00, error =  3.4120316e+00
kappa =  1.7653793e+00, error =  3.3894732e+00
kappa =  1.7502062e+00, error =  3.3662912e+00
kappa =  1.7348218e+00, error =  3.3424557e+00
kappa =  1.7192189e+00, error =  3.3179347e+00
kappa =  1.7033898e+00, error =  3.2926941e+00
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>kappa =  1.6873267e+00, error =  3.2666975e+00
kappa =  1.6710210e+00, error =  3.2399056e+00
kappa =  1.6544638e+00, error =  3.2122765e+00
kappa =  1.6376458e+00, error =  3.1837649e+00
kappa =  1.6205569e+00, error =  3.1543223e+00
kappa =  1.6031866e+00, error =  3.1238963e+00
kappa =  1.5855236e+00, error =  3.0924304e+00
kappa =  1.5675561e+00, error =  3.0598634e+00
kappa =  1.5492714e+00, error =  3.0261292e+00
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>kappa =  1.5306560e+00, error =  2.9911561e+00
kappa =  1.5116956e+00, error =  2.9548663e+00
kappa =  1.4923748e+00, error =  2.9171749e+00
kappa =  1.4726774e+00, error =  2.8779897e+00
kappa =  1.4525859e+00, error =  2.8372099e+00
kappa =  1.4320816e+00, error =  2.7947255e+00
kappa =  1.4111445e+00, error =  2.7504157e+00
kappa =  1.3897530e+00, error =  2.7041483e+00
kappa =  1.3678843e+00, error =  2.6557779e+00
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>kappa =  1.3455136e+00, error =  2.6051445e+00
kappa =  1.3226142e+00, error =  2.5520716e+00
kappa =  1.2991577e+00, error =  2.4963648e+00
kappa =  1.2751133e+00, error =  2.4378088e+00
kappa =  1.2504480e+00, error =  2.3761660e+00
kappa =  1.2251265e+00, error =  2.3111732e+00
kappa =  1.1991107e+00, error =  2.2425397e+00
kappa =  1.1723600e+00, error =  2.1699441e+00
kappa =  1.1448313e+00, error =  2.0930327e+00
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>kappa =  1.1164790e+00, error =  2.0114176e+00
kappa =  1.0872554e+00, error =  1.9246762e+00
kappa =  1.0571115e+00, error =  1.8323543e+00
kappa =  1.0259982e+00, error =  1.7339721e+00
kappa =  9.9386811e-01, error =  1.6290382e+00
kappa =  9.6067932e-01, error =  1.5170761e+00
kappa =  9.2640015e-01, error =  1.3976688e+00
kappa =  8.9101767e-01, error =  1.2705359e+00
kappa =  8.5455032e-01, error =  1.1356573e+00
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>kappa =  8.1706754e-01, error =  9.9346933e-01
kappa =  7.7871936e-01, error =  8.4516041e-01
kappa =  7.3977980e-01, error =  6.9308591e-01
kappa =  7.0070723e-01, error =  5.4127709e-01
kappa =  6.6221970e-01, error =  3.9588569e-01
kappa =  6.2536744e-01, error =  2.6513423e-01
kappa =  5.9154961e-01, error =  1.5801468e-01
kappa =  5.6237199e-01, error =  8.1151897e-02
kappa =  5.3923615e-01, error =  3.4928627e-02
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>kappa =  5.2272732e-01, error =  1.2471334e-02
kappa =  5.1222973e-01, error =  3.7607226e-03
kappa =  5.0622644e-01, error =  9.9806100e-04
kappa =  5.0305999e-01, error =  2.4410046e-04
kappa =  5.0147427e-01, error =  5.7019420e-05
kappa =  5.0070301e-01, error =  1.3005740e-05
kappa =  5.0033353e-01, error =  2.9317722e-06
kappa =  5.0015785e-01, error =  6.5713316e-07
Converged after 106 iterations
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kappa_hist</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/36a47bce97e60355555e52d45e5d7336274a0cf266036aab9c9e9ed3d6cabd09.svg" src="../../_images/36a47bce97e60355555e52d45e5d7336274a0cf266036aab9c9e9ed3d6cabd09.svg" />
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "mariejvaucher/aero523-fall24",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./Examples/Week3"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="Week3.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Week 3</p>
      </div>
    </a>
    <a class="right-next"
       href="../Week4/Week4.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Week 4</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#convergence-study">Convergence study</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-thermal-conductivity-from-measurement-data">Learning thermal conductivity from measurement data</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Alasdair Christison Gray
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>